<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify Email - SecureReview</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header class="site-header">
    <div class="header-content">
      <h1>SecureReview</h1>
      <nav>
        <a href="/">Home</a>
        <a href="/login.html">Login</a>
        <a href="/signup.html">Sign Up</a>
      </nav>
    </div>
  </header>
  <main class="container">
    <div class="card">
      <h3>Verify Your Email</h3>
      <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">
        A 6-digit verification code has been sent to your email address. Enter it below to complete your registration.
      </p>
      <form id="verify-form">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input id="email" type="email" name="email" placeholder="your@email.com" readonly style="background: rgba(255,255,255,0.02); cursor: not-allowed;" />
        </div>
        <div class="form-group">
          <label for="otp">OTP Code <span style="color: #ef4444;">*</span></label>
          <input id="otp" type="text" name="otp" placeholder="Enter 6-digit code" maxlength="6" inputmode="numeric" required style="font-size: 24px; font-weight: bold; letter-spacing: 8px; text-align: center;" />
          <small style="color: var(--text-secondary); font-size: 12px; margin-top: 8px; display: block;">
            üìß Check your email inbox (and spam folder) for the verification code
          </small>
        </div>
        <button type="submit" id="verify-btn">Verify Email</button>
      </form>
      <div id="verify-message" class="message"></div>
      <p style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 14px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 16px;">
        Didn't receive the code? <a href="/signup.html" style="color: var(--primary);">Try signing up again</a>
      </p>
      
      <div style="background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 12px; margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
        <strong style="color: #60a5fa;">üí° Testing Help:</strong><br>
        For development testing, the OTP is logged to the console. Open Developer Tools (F12) and look for the OTP in the console messages. In production, the OTP would be sent via email.
      </div>
    </div>
  </main>
  <footer class="site-footer">
    <p>SecureReview &copy; 2026. All rights reserved.</p>
  </footer>
  <script src="/app.js"></script>
  <script>
    // Get email from URL parameter
    const params = new URLSearchParams(location.search);
    const email = params.get('email');
    if (email) {
      document.getElementById('email').value = decodeURIComponent(email);
    }

    const otpInput = document.getElementById('otp');
    
    // Only allow numeric input
    otpInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 6);
    });

    document.getElementById('verify-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const email = f.email.value;
      const otp = f.otp.value;
      
      if (!email) {
        showMessage('verify-message', '‚ùå Email address is missing', 'error');
        return;
      }
      
      if (!otp || otp.length !== 6) {
        showMessage('verify-message', '‚ùå Please enter a valid 6-digit code', 'error');
        otpInput.focus();
        return;
      }
      
      try {
        const btn = document.getElementById('verify-btn');
        btn.disabled = true;
        btn.textContent = 'Verifying...';
        
        const res = await postJSON('/api/verify-otp', { email, otp });
        
        if (res.ok) {
          showMessage('verify-message', '‚úì Email verified successfully! Your account is active. Redirecting to login...', 'success');
          setTimeout(() => {
            location.href = '/login.html';
          }, 2000);
        } else {
          btn.disabled = false;
          btn.textContent = 'Verify Email';
          const errorMsg = res.error === 'invalid' ? 'Invalid OTP code. Please check and try again.' : 
                          res.error === 'expired' ? 'OTP code has expired. Please sign up again.' :
                          res.error === 'otp used' ? 'This OTP code has already been used.' :
                          res.error || 'Verification failed';
          showMessage('verify-message', '‚ùå ' + errorMsg, 'error');
        }
      } catch (err) {
        const btn = document.getElementById('verify-btn');
        btn.disabled = false;
        btn.textContent = 'Verify Email';
        showMessage('verify-message', '‚ùå Error: ' + err.message, 'error');
      }
    });
  </script>
</body>
</html>
