doctype html
html(lang='en')
  head
    meta(charset='UTF-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    title Papers - Research Paper Portal
    link(rel='stylesheet', href='/styles/main.css')
    link(href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css', rel='stylesheet')
  body
    nav.navbar
      .container
        .navbar-brand
          h1
            i.fas.fa-book
            |  Research Portal
        ul.nav-menu
          li
            a(href='/papers') Papers
          li
            a(href='/dashboard') Dashboard
          li.user-menu
            .user-info
              span.username#userName -
              span.role#userRole -
            a(href='#logout', class='btn btn-danger') Logout

    .papers-section
      .container
        .dashboard-header
          h1 Papers
          .filter-group
            select#filterStatus
              option(value='') All Statuses
              option(value='SUBMITTED') Submitted
              option(value='UNDER_REVIEW') Under Review
              option(value='ACCEPTED') Accepted
              option(value='REJECTED') Rejected
              option(value='REVISION_REQUESTED') Revision Requested

        .form-message#message

        .table-container
          table
            thead
              tr
                th Title
                th Author
                th Status
                th Submitted
                th(style='width: 250px;') Actions
            tbody#papersList
              tr
                td(colspan='5', style='text-align: center; padding: 2rem;')
                  p No papers yet. Waiting to load...


    script.
      let currentUser = null;
      let allPapers = [];
      
      // Load current user
      async function loadUser() {
        try {
          const response = await fetch('/api/auth/me', { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            currentUser = data.user;
            document.getElementById('userName').textContent = data.user.fullName;
            document.getElementById('userRole').textContent = data.user.role;
            return data.user;
          } else {
            window.location.href = '/login';
          }
        } catch (error) {
          window.location.href = '/login';
        }
      }
      
      // Load papers
      async function loadPapers() {
        try {
          console.log('Papers: loadPapers starting');
          
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          
          const response = await fetch('/api/papers', { 
            credentials: 'include',
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          
          console.log('Papers: API response:', response.status);
          
          if (response.status === 401 || response.status === 403) {
            console.log('Papers: Unauthorized, redirecting to login');
            window.location.href = '/login';
            return;
          }

          if (response.ok) {
            const data = await response.json();
            allPapers = data.papers || [];
            console.log('Papers: Loaded papers from API:', allPapers.length);
            renderPapers(allPapers);
          } else {
            console.error('Papers: API error:', response.status);
            renderPapers([]); // Show empty list on error
          }
        } catch (error) {
          console.error('Papers: Error loading papers:', error);
          renderPapers([]); // Show empty list on error
        }
      }
      
      function renderPapers(papers) {
        const tbody = document.getElementById('papersList');
        
        console.log('[renderPapers] Input papers:', papers);
        console.log('[renderPapers] Length:', papers ? papers.length : 'null');
        
        if (!papers || papers.length === 0) {
          console.log('[renderPapers] No papers to display');
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 2rem;">
                <i class="fas fa-inbox"></i> No papers found
              </td>
            </tr>
          `;
          return;
        }
        
        console.log('[renderPapers] Rendering', papers.length, 'papers');
        tbody.innerHTML = papers.map(paper => {
          console.log('[renderPapers] Paper:', paper);
          const canReview = paper.status === 'SUBMITTED' || paper.status === 'UNDER_REVIEW';
          let actionButtons = '';
          
          // Role-based action buttons
          if (currentUser.role === 'Reviewer') {
            // Reviewers can accept/reject papers in review status
            if (canReview) {
              actionButtons = `
                    <button class="btn btn-success btn-sm" onclick="updatePaperStatus('${paper._id}', 'ACCEPTED')" style="background: #10b981; color: white; margin-right: 5px;">
                      <i class="fas fa-check"></i> Accept
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="updatePaperStatus('${paper._id}', 'REJECTED')" style="background: #ef4444; color: white;">
                      <i class="fas fa-times"></i> Reject
                    </button>`;
            } else {
              actionButtons = `<span style="color: #64748b; font-size: 0.875rem;">No action needed</span>`;
            }
          } else if (currentUser.role === 'Author') {
            // Authors can view and download their own papers
            actionButtons = `
                    <button class="btn btn-primary btn-sm" onclick="viewPaper('${paper._id}')" style="background: #3b82f6; color: white; margin-right: 5px;">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <a href="/api/papers/${paper._id}/download" class="btn btn-secondary btn-sm" style="text-decoration: none;">
                      <i class="fas fa-download"></i> Download
                    </a>`;
          } else if (currentUser.role === 'Editor') {
            // Editors can view and download papers they have access to
            actionButtons = `
                    <button class="btn btn-primary btn-sm" onclick="viewPaper('${paper._id}')" style="background: #3b82f6; color: white; margin-right: 5px;">
                      <i class="fas fa-eye"></i> View
                    </button>
                    <a href="/api/papers/${paper._id}/download" class="btn btn-secondary btn-sm" style="text-decoration: none;">
                      <i class="fas fa-download"></i> Download
                    </a>`;
          } else {
            actionButtons = `<span style="color: #64748b; font-size: 0.875rem;">No actions available</span>`;
          }
          
          return `
            <tr id="paper-row-${paper._id}">
              <td>
                <strong>${paper.title || 'Untitled'}</strong>
                <br>
                <small style="color: #64748b;">${(paper.abstractText || '').substring(0, 100)}...</small>
              </td>
              <td>${paper.authorId && paper.authorId.fullName ? paper.authorId.fullName : 'Unknown'}</td>
              <td>
                <span class="status-badge status-${paper.status.toLowerCase().replace('_', '-')}" id="status-${paper._id}">
                  ${paper.status}
                </span>
              </td>
              <td>${new Date(paper.submittedAt).toLocaleDateString()}</td>
              <td>
                ${actionButtons}
              </td>
            </tr>
          `;
        }).join('');
        
        console.log('[renderPapers] HTML generated');
        console.log('[renderPapers] Done');
      }
      
      // Update paper status when reviewer accepts or rejects
      async function updatePaperStatus(paperId, newStatus) {
        try {
          console.log('[updatePaperStatus] Updating paper', paperId, 'to', newStatus);
          
          const response = await fetch(`/api/papers/${paperId}/decision`, {
            method: 'PUT',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: newStatus
            })
          });
          
          if (response.ok) {
            console.log('[updatePaperStatus] Success!');
            
            // Update UI immediately
            const statusElement = document.getElementById(`status-${paperId}`);
            if (statusElement) {
              const statusClass = newStatus.toLowerCase().replace('_', '-');
              statusElement.textContent = newStatus;
              statusElement.className = `status-badge status-${statusClass}`;
            }
            
            // Update the button row to show "No action needed"
            const row = document.getElementById(`paper-row-${paperId}`);
            if (row) {
              const buttonCell = row.lastElementChild;
              buttonCell.innerHTML = `<span style="color: #64748b; font-size: 0.875rem;">Status: ${newStatus}</span>`;
            }
            
            alert(`Paper ${newStatus.toLowerCase()}.`);
          } else {
            console.error('[updatePaperStatus] API returned:', response.status);
            alert('Failed to update paper status');
          }
        } catch (error) {
          console.error('[updatePaperStatus] Error:', error);
          alert('Error updating paper: ' + error.message);
        }
      }
      
      async function viewPaper(paperId) {
        try {
          const response = await fetch(`/api/papers/${paperId}`, { credentials: 'include' });
          if (response.ok) {
            const data = await response.json();
            showPaperModal(data.paper);
          } else {
            alert('Failed to load paper');
          }
        } catch (error) {
          console.error('Error loading paper:', error);
        }
      }
      
      function showPaperModal(paper) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>${paper.title}</h2>
              <button class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
              <h4>Abstract</h4>
              <p>${paper.abstractText}</p>
              
              <h4>Status</h4>
              <p><span class="status-badge status-${paper.status.toLowerCase().replace('_', '-')}">${paper.status}</span></p>
              
              <h4>Metadata</h4>
              <ul>
                <li><strong>Author:</strong> ${paper.authorId?.fullName || 'Unknown'}</li>
                <li><strong>Submitted:</strong> ${new Date(paper.submittedAt).toLocaleDateString()}</li>
                <li><strong>File:</strong> ${paper.fileName}</li>
              </ul>
              
              <div class="button-group">
                <a href="/api/papers/${paper._id}/download" class="btn btn-primary">
                  <i class="fas fa-download"></i> Download PDF
                </a>
                <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                  Close
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
        
        modal.querySelector('.btn-close').addEventListener('click', () => {
          modal.remove();
        });
      }
      
      // Filter by status
      document.getElementById('filterStatus').addEventListener('change', (e) => {
        const status = e.target.value;
        if (status) {
          const filtered = allPapers.filter(p => p.status === status);
          renderPapers(filtered);
        } else {
          renderPapers(allPapers);
        }
      });
      
      // Logout
      document.querySelector('a[href="#logout"]').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
          });
          window.location.href = '/login';
        } catch (error) {
          console.error('Logout error:', error);
        }
      });
      
      // Initialize
      loadUser().then(() => loadPapers());
    
    style.
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      
      .modal-content {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        width: 90%;
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .modal-header h2 {
        margin: 0;
      }
      
      .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
      }
      
      .modal-body {
        padding: 1.5rem;
      }
      
      .filter-group {
        margin-top: 1rem;
      }
      
      .filter-group select {
        max-width: 250px;
      }
